name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  test:
    name: Vet + Test + Race (Go 1.24)
    runs-on: macos-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"
          cache: true

      - name: Verify formatting
        run: |
          unformatted=$(gofmt -l .)
          if [ -n "$unformatted" ]; then
            echo "The following files need gofmt:"
            echo "$unformatted"
            exit 1
          fi

      - name: Go vet
        run: go vet ./...

      - name: Unit tests
        run: go test ./...

      - name: Race tests
        run: go test -race ./...

  benchmark-regression:
    name: Bench regression (warning-only)
    if: github.event_name == 'pull_request'
    runs-on: macos-latest
    timeout-minutes: 20

    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"
          cache: true

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@latest

      - name: Compare hot-path benchmarks (base vs PR)
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.sha }}
          BENCH_REGEX: Benchmark(ParseCursorDBLines|FormatTokenCount|AlertMonitorCheckNoAlert|AlertMonitorCheckFleet)$
          REGRESSION_THRESHOLD_PCT: "20"
        run: |
          set -euo pipefail

          git checkout "$BASE_SHA"
          go test ./monitor -run '^$' -bench "$BENCH_REGEX" -benchmem > /tmp/bench_base.txt

          git checkout "$HEAD_SHA"
          go test ./monitor -run '^$' -bench "$BENCH_REGEX" -benchmem > /tmp/bench_head.txt

          "$(go env GOPATH)/bin/benchstat" /tmp/bench_base.txt /tmp/bench_head.txt > /tmp/benchstat.txt

          echo "---- benchstat (base -> PR) ----"
          cat /tmp/benchstat.txt

          regressions=$(awk -v threshold="$REGRESSION_THRESHOLD_PCT" '
            {
              while (match($0, /\+[0-9]+(\.[0-9]+)?%/)) {
                pct = substr($0, RSTART+1, RLENGTH-2) + 0
                if (pct > threshold) count++
                $0 = substr($0, RSTART + RLENGTH)
              }
            }
            END { print count+0 }
          ' /tmp/benchstat.txt)

          if [ "$regressions" -gt 0 ]; then
            echo "::warning::Benchmark regression warning: detected $regressions metric(s) above ${REGRESSION_THRESHOLD_PCT}% (non-blocking)."
          fi

          {
            echo "## Benchmark Comparison (base -> PR)"
            echo
            echo "Threshold for warning: ${REGRESSION_THRESHOLD_PCT}% (non-blocking)"
            echo
            echo '```'
            cat /tmp/benchstat.txt
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"
